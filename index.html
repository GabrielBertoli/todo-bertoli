<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Todo Bertoli</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#FAF9F7;--surface:#FFF;--text:#1D1D1F;--text-2:#6E6E73;--text-3:#AEAEB2;
    --accent:#2D6A4F;--accent-bg:#EAF5EE;--red:#DE4C4A;--red-bg:#FDECEC;
    --blue:#4A90D9;--blue-bg:#EBF3FC;--orange:#FF9500;--orange-bg:#FFF3E0;
    --purple:#8B7EC8;--purple-bg:#EEEAFF;
    --border:#EEEBE6;--divider:#EEEBE5;--hover:#F5F3EF;
  }
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  body{font-family:'Inter',-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100dvh;-webkit-font-smoothing:antialiased}
  .app{max-width:560px;margin:0 auto;padding-bottom:80px}

  .header{padding:16px 20px 0;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--bg);z-index:50}
  .h-left{display:flex;align-items:center;gap:10px}
  .h-btn{width:34px;height:34px;border-radius:50%;background:var(--border);border:none;cursor:pointer;font-size:15px;display:flex;align-items:center;justify-content:center;color:var(--text-2);transition:background .15s}
  .h-btn:hover{background:var(--divider)}
  .h-title{font-size:17px;font-weight:700;letter-spacing:-.2px}
  .h-right{display:flex;gap:6px}
  .h-btn.star{color:#FFB800;background:#FFF8E0}

  .hero{padding:24px 20px 4px}
  .hero-brand{font-size:14px;color:var(--text-2);font-weight:500;margin-bottom:8px}
  .hero-line{height:3px;background:var(--red);border-radius:3px;width:0;animation:draw .8s .3s cubic-bezier(.4,0,.2,1) forwards;position:relative}
  .hero-line::before{content:'‚úèÔ∏è';position:absolute;right:-14px;top:-11px;font-size:13px}
  @keyframes draw{to{width:120px}}

  .filters{display:flex;gap:6px;padding:14px 20px 0;overflow-x:auto;scrollbar-width:none}
  .filters::-webkit-scrollbar{display:none}
  .chip{padding:7px 13px;border-radius:20px;border:1.5px solid var(--border);background:var(--surface);font-family:inherit;font-size:12px;font-weight:600;color:var(--text-2);cursor:pointer;white-space:nowrap;transition:all .15s}
  .chip:hover{border-color:var(--text-3)}
  .chip.on{background:var(--text);color:#fff;border-color:var(--text)}

  .sec{padding:20px 20px 0}
  .sec-head{display:flex;align-items:center;gap:7px;margin-bottom:4px}
  .sec-icon{font-size:15px}
  .sec-title{font-size:14px;font-weight:800;letter-spacing:-.2px}
  .sec-desc{font-size:12px;color:var(--text-2);margin-bottom:14px}

  .tl{display:flex;flex-direction:column}
  .tr{display:flex;align-items:center;gap:12px;padding:12px 20px;border-bottom:1px solid var(--divider);transition:background .1s;cursor:pointer;animation:ri .25s ease both}
  .tr:hover{background:var(--hover)}
  @keyframes ri{from{opacity:0;transform:translateY(3px)}to{opacity:1}}

  .ck{width:20px;height:20px;border-radius:50%;border:2px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .2s;cursor:pointer}
  .ck:hover{border-color:var(--accent);background:var(--accent-bg)}
  .ck.p1{border-color:var(--red)}.ck.p1:hover{background:var(--red-bg)}
  .ck.p2{border-color:var(--orange)}.ck.p2:hover{background:var(--orange-bg)}
  .ck.p3{border-color:var(--blue)}.ck.p3:hover{background:var(--blue-bg)}
  .tr.done .ck{background:var(--text-3);border-color:var(--text-3)}
  .tr.done .ck::after{content:'‚úì';font-size:10px;color:#fff;font-weight:800}

  .tc{flex:1;min-width:0}
  .tt{font-size:14px;font-weight:500;line-height:1.4;word-break:break-word;transition:all .2s}
  .tr.done .tt{text-decoration:line-through;color:var(--text-3)}
  .tm{display:flex;align-items:center;gap:5px;margin-top:3px;flex-wrap:wrap}
  .tm-tag{font-size:10px;font-weight:600;padding:2px 7px;border-radius:4px;display:flex;align-items:center;gap:3px}
  .tm-pri{background:var(--red-bg);color:var(--red)}
  .tm-pri.p2{background:var(--orange-bg);color:var(--orange)}
  .tm-pri.p3{background:var(--blue-bg);color:var(--blue)}
  .tm-sub{background:var(--border);color:var(--text-2)}
  .tm-time{background:var(--purple-bg);color:var(--purple)}
  .tm-label{border-radius:4px;font-size:10px;font-weight:600;padding:2px 7px}
  .tm-date{background:var(--accent-bg);color:var(--accent)}
  .tm-desc{background:#F5F3EF;color:var(--text-2)}

  .t-right{display:flex;align-items:center;gap:8px;flex-shrink:0}
  .t-del{background:none;border:none;color:var(--text-3);cursor:pointer;padding:4px;font-size:12px;opacity:0;transition:all .15s;border-radius:6px}
  .tr:hover .t-del{opacity:.6}
  .t-del:hover{opacity:1!important;color:var(--red);background:var(--red-bg)}
  .t-handle{color:var(--text-3);font-size:13px;opacity:.3;user-select:none;letter-spacing:1px}
  .tr:hover .t-handle{opacity:.7}

  .ar{display:flex;align-items:center;gap:12px;padding:12px 20px;cursor:pointer;transition:background .1s}
  .ar:hover{background:var(--hover)}
  .ar-icon{width:20px;height:20px;border-radius:50%;border:2px dashed var(--text-3);display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--text-3);font-weight:700;flex-shrink:0;transition:all .15s}
  .ar:hover .ar-icon{border-color:var(--accent);color:var(--accent)}
  .ar-label{font-size:13px;color:var(--text-3);font-weight:500}
  .ar:hover .ar-label{color:var(--text-2)}

  .ii{display:none;align-items:center;gap:12px;padding:8px 20px;border-bottom:1px solid var(--divider);background:var(--surface)}
  .ii.show{display:flex}
  .ii input{flex:1;border:none;outline:none;font-family:inherit;font-size:14px;font-weight:500;color:var(--text);background:transparent;padding:5px 0}
  .ii input::placeholder{color:var(--text-3)}

  /* SHEET */
  .sheet-overlay{position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:200;display:none;backdrop-filter:blur(2px)}
  .sheet-overlay.show{display:block;animation:oIn .2s ease}
  @keyframes oIn{from{opacity:0}to{opacity:1}}

  .sheet{position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-radius:16px 16px 0 0;z-index:201;transform:translateY(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);max-height:90dvh;overflow-y:auto;padding-bottom:max(20px,env(safe-area-inset-bottom))}
  .sheet.show{transform:translateY(0)}
  .sheet-grab{width:36px;height:4px;background:var(--border);border-radius:4px;margin:10px auto 0}

  .sheet-head{padding:14px 20px 0;display:flex;align-items:center;justify-content:space-between}
  .sh-close{font-size:13px;font-weight:600;color:var(--accent);cursor:pointer;padding:6px 12px;border-radius:8px;border:none;background:transparent}
  .sh-close:hover{background:var(--accent-bg)}

  .sheet-task{padding:14px 20px 0;display:flex;align-items:flex-start;gap:14px}
  .sheet-task .ck{margin-top:3px}
  .sheet-task-text{font-size:17px;font-weight:700;line-height:1.35;flex:1;outline:none;min-height:24px}

  .sf{padding:8px 20px 0}
  .sf-row{display:flex;align-items:center;gap:12px;padding:14px 0;border-bottom:1px solid var(--divider);cursor:pointer;transition:background .1s;margin:0 -20px;padding-left:20px;padding-right:20px}
  .sf-row:hover{background:var(--hover)}
  .sf-icon{font-size:16px;width:24px;text-align:center;flex-shrink:0}
  .sf-label{font-size:14px;font-weight:500;color:var(--text);flex:1}
  .sf-value{font-size:13px;font-weight:600;color:var(--accent);display:flex;align-items:center;gap:4px}
  .sf-value.muted{color:var(--text-3)}

  /* Priority picker */
  .pri-picker{display:none;padding:8px 20px;gap:6px;flex-wrap:wrap}
  .pri-picker.show{display:flex}
  .pri-opt{padding:8px 16px;border-radius:20px;border:2px solid var(--border);background:var(--surface);font-family:inherit;font-size:13px;font-weight:600;color:var(--text-2);cursor:pointer;transition:all .15s}
  .pri-opt:hover{border-color:var(--text-3)}
  .pri-opt.on{color:#fff}
  .pri-opt[data-p="1"].on{background:var(--red);border-color:var(--red)}
  .pri-opt[data-p="2"].on{background:var(--orange);border-color:var(--orange)}
  .pri-opt[data-p="3"].on{background:var(--blue);border-color:var(--blue)}
  .pri-opt[data-p="4"].on{background:var(--text-3);border-color:var(--text-3)}

  /* Label picker */
  .label-picker{display:none;padding:8px 20px;gap:6px;flex-wrap:wrap}
  .label-picker.show{display:flex}
  .lb-opt{padding:7px 14px;border-radius:20px;border:2px solid var(--border);background:var(--surface);font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s}
  .lb-opt:hover{border-color:var(--text-3)}
  .lb-opt.on{color:#fff}
  .lb-perso{color:#C67D4A}.lb-perso.on{background:#C67D4A;border-color:#C67D4A}
  .lb-travail{color:var(--accent)}.lb-travail.on{background:var(--accent);border-color:var(--accent)}
  .lb-urgent{color:var(--red)}.lb-urgent.on{background:var(--red);border-color:var(--red)}
  .lb-famille{color:var(--purple)}.lb-famille.on{background:var(--purple);border-color:var(--purple)}
  .lb-idees{color:var(--blue)}.lb-idees.on{background:var(--blue);border-color:var(--blue)}

  /* Date picker */
  .date-picker{display:none;padding:8px 20px;gap:6px;flex-wrap:wrap}
  .date-picker.show{display:flex}
  .dt-opt{padding:8px 14px;border-radius:20px;border:2px solid var(--border);background:var(--surface);font-family:inherit;font-size:12px;font-weight:600;color:var(--text-2);cursor:pointer;transition:all .15s}
  .dt-opt:hover{border-color:var(--text-3)}
  .dt-opt.on{background:var(--accent);color:#fff;border-color:var(--accent)}
  .dt-custom{border:none;font-family:inherit;font-size:13px;font-weight:600;color:var(--accent);background:transparent;cursor:pointer;padding:8px 4px}

  /* Time picker */
  .time-row{display:none;padding:8px 20px;align-items:center;gap:10px}
  .time-row.show{display:flex}
  .time-row input[type=time]{font-family:inherit;font-size:15px;font-weight:600;border:2px solid var(--border);border-radius:12px;padding:8px 14px;background:var(--surface);color:var(--text);outline:none;cursor:pointer}
  .time-row input[type=time]:focus{border-color:var(--accent)}
  .time-clear{font-size:12px;color:var(--text-3);cursor:pointer;padding:6px 10px;border-radius:8px;border:none;background:var(--border);font-family:inherit;font-weight:600}
  .time-clear:hover{background:var(--divider)}

  /* Description */
  .desc-area{display:none;padding:8px 20px}
  .desc-area.show{display:block}
  .desc-area textarea{width:100%;border:2px solid var(--border);border-radius:12px;padding:12px 14px;font-family:inherit;font-size:14px;font-weight:500;color:var(--text);background:var(--surface);outline:none;resize:vertical;min-height:80px}
  .desc-area textarea:focus{border-color:var(--accent)}
  .desc-area textarea::placeholder{color:var(--text-3)}

  /* Sub-tasks */
  .sheet-subs{padding:16px 20px 0}
  .ss-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .ss-title{font-size:14px;font-weight:800}
  .ss-count{font-size:12px;color:var(--text-3);font-weight:500}

  .sub-row{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--divider)}
  .sub-row:last-of-type{border-bottom:none}
  .sub-ck{width:18px;height:18px;border-radius:50%;border:2px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s}
  .sub-ck:hover{border-color:var(--accent);background:var(--accent-bg)}
  .sub-row.done .sub-ck{background:var(--text-3);border-color:var(--text-3)}
  .sub-row.done .sub-ck::after{content:'‚úì';font-size:9px;color:#fff;font-weight:800}
  .sub-text{font-size:14px;font-weight:500;flex:1}
  .sub-row.done .sub-text{text-decoration:line-through;color:var(--text-3)}
  .sub-del{background:none;border:none;font-size:11px;color:var(--text-3);cursor:pointer;opacity:.4;transition:opacity .15s;padding:4px}
  .sub-del:hover{opacity:1;color:var(--red)}

  .add-sub{padding:10px 0;cursor:pointer;display:flex;align-items:center;gap:8px}
  .add-sub span{font-size:13px;font-weight:600;color:var(--accent)}
  .add-sub:hover span{text-decoration:underline}
  .sub-input{display:none;align-items:center;gap:12px;padding:6px 0}
  .sub-input.show{display:flex}
  .sub-input input{flex:1;border:2px solid var(--border);border-radius:10px;padding:8px 12px;outline:none;font-family:inherit;font-size:14px;font-weight:500;color:var(--text);background:var(--surface)}
  .sub-input input:focus{border-color:var(--accent)}
  .sub-input input::placeholder{color:var(--text-3)}

  /* Comment section */
  .sheet-comments{padding:16px 20px 0;border-top:1px solid var(--divider);margin-top:12px}
  .sc-title{font-size:14px;font-weight:800;margin-bottom:10px}
  .comment-item{padding:8px 0;border-bottom:1px solid var(--divider)}
  .comment-item:last-of-type{border-bottom:none}
  .ci-text{font-size:13px;color:var(--text);line-height:1.4}
  .ci-time{font-size:11px;color:var(--text-3);margin-top:2px}
  .comment-input-row{display:flex;gap:8px;align-items:center;padding:10px 0}
  .comment-input-row input{flex:1;border:2px solid var(--border);border-radius:10px;padding:8px 12px;outline:none;font-family:inherit;font-size:13px;font-weight:500;color:var(--text);background:var(--surface)}
  .comment-input-row input:focus{border-color:var(--accent)}
  .comment-input-row input::placeholder{color:var(--text-3)}
  .comment-input-row button{width:34px;height:34px;border-radius:50%;background:var(--accent);color:#fff;border:none;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:transform .1s}
  .comment-input-row button:hover{transform:scale(1.05)}
  .comment-input-row button:disabled{background:var(--border);color:var(--text-3);cursor:default;transform:none}

  /* Toolbar */
  .toolbar{position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--divider);padding:10px 20px;padding-bottom:max(10px,env(safe-area-inset-bottom));z-index:100;display:flex;align-items:center;gap:6px;overflow-x:auto;scrollbar-width:none}
  .toolbar::-webkit-scrollbar{display:none}
  .tb{padding:8px 14px;border-radius:10px;border:1.5px solid var(--border);background:var(--surface);font-family:inherit;font-size:12px;font-weight:600;color:var(--text-2);cursor:pointer;white-space:nowrap;display:flex;align-items:center;gap:5px;transition:all .15s}
  .tb:hover{border-color:var(--text-3);background:var(--hover)}
  .tb-sep{width:1px;height:24px;background:var(--divider);flex-shrink:0;margin:0 2px}

  .empty{text-align:center;padding:50px 30px}
  .empty .ei{font-size:36px;margin-bottom:10px}
  .empty .et{font-size:15px;font-weight:700;margin-bottom:3px}
  .empty .es{font-size:12px;color:var(--text-2)}

  @media(max-width:480px){.t-del{opacity:.3}}
  @media(prefers-color-scheme:dark){:root{--bg:#121212;--surface:#1C1C1E;--text:#F5F5F7;--text-2:#8E8E93;--text-3:#48484A;--border:#2C2C2E;--divider:#2C2C2E;--hover:#252528;--accent:#52B788;--accent-bg:#1a3328;--red-bg:#2a1616;--blue-bg:#162030;--orange-bg:#2e2416;--purple-bg:#1e1a2e}}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="h-left"><button class="h-btn">‚Äπ</button><span class="h-title">Todo Bertoli</span></div>
    <div class="h-right"><button class="h-btn star">‚òÖ</button></div>
  </div>
  <div class="hero"><div class="hero-brand">Bertoli.</div><div class="hero-line"></div></div>
  <div class="filters" id="filters">
    <button class="chip on" data-f="all">Tout</button>
    <button class="chip" data-f="active">√Ä faire</button>
    <button class="chip" data-f="done">Termin√©es</button>
    <button class="chip" data-f="p1">üî¥ P1</button>
    <button class="chip" data-f="p2">üü† P2</button>
    <button class="chip" data-f="p3">üîµ P3</button>
  </div>
  <div class="sec">
    <div class="sec-head"><span class="sec-icon">‚úÖ</span><span class="sec-title">Mes t√¢ches</span></div>
    <div class="sec-desc" id="desc"></div>
  </div>
  <div class="tl" id="tl"></div>
  <div class="ii" id="ii"><div class="ck"></div><input id="ni" placeholder="Nouvelle t√¢che..." autocomplete="off"></div>
  <div class="ar" id="ar"><div class="ar-icon">+</div><span class="ar-label">Nouvelle t√¢che</span></div>
</div>

<!-- Detail sheet -->
<div class="sheet-overlay" id="so"></div>
<div class="sheet" id="sheet">
  <div class="sheet-grab"></div>
  <div class="sheet-head">
    <span style="font-size:13px;font-weight:600;color:var(--text-2)">üìã D√©tails</span>
    <button class="sh-close" id="shClose">‚úï Fermer</button>
  </div>
  <div class="sheet-task">
    <div class="ck" id="shCk"></div>
    <div class="sheet-task-text" contenteditable="true" id="shTitle"></div>
  </div>

  <div class="sf">
    <!-- Date -->
    <div class="sf-row" id="sfDate">
      <span class="sf-icon">üìÖ</span>
      <span class="sf-label">Date</span>
      <span class="sf-value muted" id="sfDateVal">Aucune</span>
    </div>
    <div class="date-picker" id="datePicker">
      <button class="dt-opt" data-d="today">Aujourd'hui</button>
      <button class="dt-opt" data-d="tomorrow">Demain</button>
      <button class="dt-opt" data-d="week">Cette semaine</button>
      <button class="dt-opt" data-d="none">Aucune</button>
      <input type="date" class="dt-custom" id="customDate">
    </div>

    <!-- Time -->
    <div class="sf-row" id="sfTime">
      <span class="sf-icon">‚è∞</span>
      <span class="sf-label">Heure</span>
      <span class="sf-value muted" id="sfTimeVal">Aucune</span>
    </div>
    <div class="time-row" id="timePicker">
      <input type="time" id="timeInput">
      <button class="time-clear" id="timeClear">Effacer</button>
    </div>

    <!-- Priority -->
    <div class="sf-row" id="sfPri">
      <span class="sf-icon">üö©</span>
      <span class="sf-label">Priorit√©</span>
      <span class="sf-value muted" id="sfPriVal">P4</span>
    </div>
    <div class="pri-picker" id="priPicker">
      <button class="pri-opt" data-p="1">üî¥ Priorit√© 1</button>
      <button class="pri-opt" data-p="2">üü† Priorit√© 2</button>
      <button class="pri-opt" data-p="3">üîµ Priorit√© 3</button>
      <button class="pri-opt" data-p="4">‚ö™ Priorit√© 4</button>
    </div>

    <!-- Labels -->
    <div class="sf-row" id="sfLabel">
      <span class="sf-icon">üè∑</span>
      <span class="sf-label">Label</span>
      <span class="sf-value muted" id="sfLabelVal">Aucun</span>
    </div>
    <div class="label-picker" id="labelPicker">
      <button class="lb-opt lb-perso" data-l="perso">üè† Perso</button>
      <button class="lb-opt lb-travail" data-l="travail">üíº Travail</button>
      <button class="lb-opt lb-urgent" data-l="urgent">üî• Urgent</button>
      <button class="lb-opt lb-famille" data-l="famille">üë®‚Äçüëß‚Äçüëß Famille</button>
      <button class="lb-opt lb-idees" data-l="id√©es">üí° Id√©es</button>
    </div>

    <!-- Description -->
    <div class="sf-row" id="sfDesc">
      <span class="sf-icon">üìù</span>
      <span class="sf-label">Description</span>
      <span class="sf-value muted" id="sfDescVal">Ajouter</span>
    </div>
    <div class="desc-area" id="descArea">
      <textarea id="descInput" placeholder="Ajoutez une description..." rows="3"></textarea>
    </div>
  </div>

  <!-- Sub-tasks -->
  <div class="sheet-subs" id="shSubs">
    <div class="ss-head">
      <span class="ss-title">Sous-t√¢ches <span class="ss-count" id="ssCount">0/0</span></span>
    </div>
    <div id="ssList"></div>
    <div class="add-sub" id="addSub"><span>+ Ajouter une sous-t√¢che</span></div>
    <div class="sub-input" id="subInput"><input id="subNi" placeholder="Sous-t√¢che..." autocomplete="off"></div>
  </div>

  <!-- Comments -->
  <div class="sheet-comments" id="shComments">
    <div class="sc-title">üí¨ Commentaires</div>
    <div id="commentList"></div>
    <div class="comment-input-row">
      <input id="commentInput" placeholder="Ajouter un commentaire..." autocomplete="off">
      <button id="commentSend" disabled>‚Üë</button>
    </div>
  </div>
</div>

<!-- Toolbar -->
<div class="toolbar" id="toolbar">
  <button class="tb" id="tbAdd"><span>Ôºã</span> Nouvelle t√¢che</button>
  <div class="tb-sep"></div>
  <button class="tb" id="tbSort">‚ÜïÔ∏è Trier</button>
  <button class="tb" id="tbClear">üóë Purger termin√©es</button>
</div>

<script>
const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s);
let todos=JSON.parse(localStorage.getItem('bertoli-v6')||'[]');
let filter='all',openIdx=null;

function save(){localStorage.setItem('bertoli-v6',JSON.stringify(todos))}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function ensureFields(t){
  if(!t.subs)t.subs=[];if(!t.priority)t.priority=4;
  if(!t.time)t.time='';if(!t.comments)t.comments=[];
  if(!t.label)t.label='';if(!t.desc)t.desc='';if(!t.date)t.date='';
  return t;
}

const pBorder={1:'p1',2:'p2',3:'p3',4:''};
const pLabel={1:'P1',2:'P2',3:'P3',4:'P4'};
const pColors={1:'var(--red)',2:'var(--orange)',3:'var(--blue)'};
const labelNames={perso:'üè† Perso',travail:'üíº Travail',urgent:'üî• Urgent',famille:'üë®‚Äçüëß‚Äçüëß Famille','id√©es':'üí° Id√©es'};
const labelColors={perso:'#FFF0E5',travail:'var(--accent-bg)',urgent:'var(--red-bg)',famille:'var(--purple-bg)','id√©es':'var(--blue-bg)'};
const labelTextColors={perso:'#C67D4A',travail:'var(--accent)',urgent:'var(--red)',famille:'var(--purple)','id√©es':'var(--blue)'};

function formatDate(d){
  if(!d)return '';
  const today=new Date();today.setHours(0,0,0,0);
  const dt=new Date(d+'T00:00:00');
  const diff=Math.round((dt-today)/86400000);
  if(diff===0)return "Aujourd'hui";
  if(diff===1)return 'Demain';
  if(diff===-1)return 'Hier';
  if(diff<-1)return `il y a ${-diff}j`;
  return dt.toLocaleDateString('fr-FR',{day:'numeric',month:'short'});
}
function dateKey(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}

function getFiltered(){
  return todos.filter(t=>{
    if(filter==='active')return !t.done;if(filter==='done')return t.done;
    if(filter==='p1')return t.priority===1&&!t.done;
    if(filter==='p2')return t.priority===2&&!t.done;
    if(filter==='p3')return t.priority===3&&!t.done;
    return true;
  });
}

function render(){
  const list=getFiltered();
  const act=todos.filter(t=>!t.done).length,dn=todos.filter(t=>t.done).length;
  $('#desc').textContent=`${act} √† faire ¬∑ ${dn} termin√©e${dn!==1?'s':''}`;
  if(!list.length){
    $('#tl').innerHTML=`<div class="empty"><div class="ei">${todos.length?'üìÇ':'‚ú®'}</div><div class="et">${todos.length?'Rien ici':'Bienvenue !'}</div><div class="es">${todos.length?'Aucune t√¢che dans ce filtre':'Ajoutez votre premi√®re t√¢che üëá'}</div></div>`;
    return;
  }
  const pOrd={1:0,2:1,3:2,4:3,undefined:3};
  const sorted=[...list].sort((a,b)=>{if(a.done!==b.done)return a.done?1:-1;return(pOrd[a.priority]||3)-(pOrd[b.priority]||3)});
  $('#tl').innerHTML=sorted.map((t,vi)=>{
    ensureFields(t);const i=todos.indexOf(t);
    let tags='';
    if(t.priority&&t.priority<4)tags+=`<span class="tm-tag tm-pri ${t.priority===2?'p2':t.priority===3?'p3':''}">üö© ${pLabel[t.priority]}</span>`;
    if(t.label&&labelNames[t.label])tags+=`<span class="tm-tag tm-label" style="background:${labelColors[t.label]};color:${labelTextColors[t.label]}">${labelNames[t.label]}</span>`;
    if(t.date)tags+=`<span class="tm-tag tm-date">üìÖ ${formatDate(t.date)}</span>`;
    if(t.time)tags+=`<span class="tm-tag tm-time">‚è∞ ${t.time}</span>`;
    if(t.subs&&t.subs.length)tags+=`<span class="tm-tag tm-sub">‚òë ${t.subs.filter(s=>s.done).length}/${t.subs.length}</span>`;
    if(t.desc)tags+=`<span class="tm-tag tm-desc">üìù</span>`;
    return `<div class="tr ${t.done?'done':''}" data-i="${i}" style="animation-delay:${vi*.03}s">
      <div class="ck ${pBorder[t.priority]||''}" onclick="event.stopPropagation();toggle(${i})"></div>
      <div class="tc" onclick="openSheet(${i})">
        <div class="tt">${esc(t.text)}</div>
        ${tags?`<div class="tm">${tags}</div>`:''}
      </div>
      <div class="t-right">
        <button class="t-del" onclick="event.stopPropagation();del(${i})">‚úï</button>
        <span class="t-handle">‚â°</span>
      </div>
    </div>`;
  }).join('');
}

function toggle(i){todos[i].done=!todos[i].done;save();render();if(openIdx===i)renderSheetCheck()}
function del(i){todos.splice(i,1);save();render();if(openIdx===i)closeSheet()}

function addTask(text){
  if(!text.trim())return;
  todos.push(ensureFields({text:text.trim(),done:false,priority:4,subs:[],time:'',date:'',label:'',desc:'',comments:[],ts:Date.now()}));
  save();render();
}

$('#ar').onclick=()=>{$('#ii').classList.add('show');$('#ar').style.display='none';$('#ni').focus()};
$('#ni').onkeydown=e=>{if(e.key==='Enter'){addTask($('#ni').value);$('#ni').value=''}if(e.key==='Escape')closeInline()};
$('#ni').onblur=()=>setTimeout(()=>{if($('#ni').value.trim()){addTask($('#ni').value);$('#ni').value=''}closeInline()},150);
function closeInline(){$('#ii').classList.remove('show');$('#ar').style.display=''}

$('#tbAdd').onclick=()=>{$('#ii').classList.add('show');$('#ar').style.display='none';$('#ni').focus()};
$('#tbClear').onclick=()=>{todos=todos.filter(t=>!t.done);save();render()};
$('#tbSort').onclick=()=>{todos.sort((a,b)=>(a.priority||4)-(b.priority||4));save();render()};

$$('.chip').forEach(c=>{c.onclick=()=>{$$('.chip').forEach(x=>x.classList.remove('on'));c.classList.add('on');filter=c.dataset.f;render()}});

// ====== SHEET ======
function closePickers(){$$('.pri-picker,.label-picker,.date-picker,.time-row,.desc-area').forEach(e=>e.classList.remove('show'))}

function openSheet(i){
  openIdx=i;closePickers();
  const t=ensureFields(todos[i]);
  $('#shTitle').textContent=t.text;
  renderSheetCheck();
  // Values
  $('#sfPriVal').textContent=pLabel[t.priority]||'P4';
  $('#sfPriVal').className='sf-value'+(t.priority<4?'':' muted');
  $('#sfLabelVal').textContent=t.label?labelNames[t.label]:'Aucun';
  $('#sfLabelVal').className='sf-value'+(t.label?'':' muted');
  $('#sfDateVal').textContent=t.date?formatDate(t.date):'Aucune';
  $('#sfDateVal').className='sf-value'+(t.date?'':' muted');
  $('#sfTimeVal').textContent=t.time||'Aucune';
  $('#sfTimeVal').className='sf-value'+(t.time?'':' muted');
  $('#sfDescVal').textContent=t.desc?'Modifier':'Ajouter';
  $('#sfDescVal').className='sf-value'+(t.desc?'':' muted');
  $('#descInput').value=t.desc||'';
  $('#timeInput').value=t.time||'';
  if(t.date)$('#customDate').value=t.date;
  // Priority buttons
  $$('.pri-opt').forEach(b=>b.classList.toggle('on',parseInt(b.dataset.p)===t.priority));
  // Label buttons
  $$('.lb-opt').forEach(b=>b.classList.toggle('on',b.dataset.l===t.label));
  // Date buttons
  const today=dateKey(new Date()),tmr=dateKey(new Date(Date.now()+86400000));
  $$('.dt-opt').forEach(b=>{
    if(b.dataset.d==='today')b.classList.toggle('on',t.date===today);
    else if(b.dataset.d==='tomorrow')b.classList.toggle('on',t.date===tmr);
    else if(b.dataset.d==='none')b.classList.toggle('on',!t.date);
    else b.classList.remove('on');
  });
  renderSubs();renderComments();
  $('#so').classList.add('show');
  setTimeout(()=>$('#sheet').classList.add('show'),10);
  $('#toolbar').style.display='none';
}

function renderSheetCheck(){
  if(openIdx===null)return;
  const t=todos[openIdx];
  $('#shCk').className='ck '+(pBorder[t.priority]||'');
  if(t.done){$('#shCk').style.background='var(--text-3)';$('#shCk').style.borderColor='var(--text-3)'}
  else{$('#shCk').style.background='';$('#shCk').style.borderColor=''}
}

function closeSheet(){
  if(openIdx!==null&&todos[openIdx]){
    const t=$('#shTitle').textContent.trim();if(t)todos[openIdx].text=t;
    todos[openIdx].desc=$('#descInput').value.trim();
    save();render();
  }
  closePickers();
  $('#sheet').classList.remove('show');
  setTimeout(()=>{$('#so').classList.remove('show');$('#toolbar').style.display=''},300);
  openIdx=null;
}
$('#so').onclick=closeSheet;
$('#shClose').onclick=closeSheet;
$('#sheet').onclick=e=>e.stopPropagation();
$('#shCk').onclick=()=>{if(openIdx!==null)toggle(openIdx)};

// Toggle pickers
function togglePicker(id){const el=$('#'+id);const show=!el.classList.contains('show');closePickers();if(show)el.classList.add('show')}
$('#sfPri').onclick=()=>togglePicker('priPicker');
$('#sfLabel').onclick=()=>togglePicker('labelPicker');
$('#sfDate').onclick=()=>togglePicker('datePicker');
$('#sfTime').onclick=()=>togglePicker('timePicker');
$('#sfDesc').onclick=()=>togglePicker('descArea');

// Priority
$$('.pri-opt').forEach(b=>{b.onclick=()=>{
  if(openIdx===null)return;
  const p=parseInt(b.dataset.p);todos[openIdx].priority=p;
  $$('.pri-opt').forEach(x=>x.classList.remove('on'));b.classList.add('on');
  $('#sfPriVal').textContent=pLabel[p];$('#sfPriVal').className='sf-value'+(p<4?'':' muted');
  renderSheetCheck();save();render();
}});

// Labels
$$('.lb-opt').forEach(b=>{b.onclick=()=>{
  if(openIdx===null)return;
  const l=b.dataset.l;
  const same=todos[openIdx].label===l;
  todos[openIdx].label=same?'':l;
  $$('.lb-opt').forEach(x=>x.classList.remove('on'));
  if(!same)b.classList.add('on');
  $('#sfLabelVal').textContent=same?'Aucun':labelNames[l];
  $('#sfLabelVal').className='sf-value'+(same?' muted':'');
  save();render();
}});

// Date
const today=new Date();today.setHours(0,0,0,0);
$$('.dt-opt').forEach(b=>{b.onclick=()=>{
  if(openIdx===null)return;
  let d='';
  if(b.dataset.d==='today')d=dateKey(new Date());
  else if(b.dataset.d==='tomorrow')d=dateKey(new Date(Date.now()+86400000));
  else if(b.dataset.d==='week'){const fri=new Date();fri.setDate(fri.getDate()+(5-fri.getDay()+7)%7);d=dateKey(fri)}
  else d='';
  todos[openIdx].date=d;
  $$('.dt-opt').forEach(x=>x.classList.remove('on'));b.classList.add('on');
  $('#sfDateVal').textContent=d?formatDate(d):'Aucune';
  $('#sfDateVal').className='sf-value'+(d?'':' muted');
  save();render();
}});
$('#customDate').onchange=()=>{
  if(openIdx===null)return;
  todos[openIdx].date=$('#customDate').value;
  $$('.dt-opt').forEach(x=>x.classList.remove('on'));
  $('#sfDateVal').textContent=formatDate($('#customDate').value);
  $('#sfDateVal').className='sf-value';
  save();render();
};

// Time
$('#timeInput').onchange=()=>{
  if(openIdx===null)return;
  todos[openIdx].time=$('#timeInput').value;
  $('#sfTimeVal').textContent=$('#timeInput').value||'Aucune';
  $('#sfTimeVal').className='sf-value'+($('#timeInput').value?'':' muted');
  save();render();
};
$('#timeClear').onclick=()=>{
  if(openIdx===null)return;
  todos[openIdx].time='';$('#timeInput').value='';
  $('#sfTimeVal').textContent='Aucune';$('#sfTimeVal').className='sf-value muted';
  save();render();
};

// Description auto-save on change
$('#descInput').oninput=()=>{
  if(openIdx===null)return;
  todos[openIdx].desc=$('#descInput').value.trim();
  $('#sfDescVal').textContent=todos[openIdx].desc?'Modifier':'Ajouter';
  $('#sfDescVal').className='sf-value'+(todos[openIdx].desc?'':' muted');
  save();render();
};

// Sub-tasks
function renderSubs(){
  if(openIdx===null)return;
  const t=ensureFields(todos[openIdx]);
  const done=t.subs.filter(s=>s.done).length;
  $('#ssCount').textContent=`${done}/${t.subs.length}`;
  $('#ssList').innerHTML=t.subs.map((s,si)=>`
    <div class="sub-row ${s.done?'done':''}">
      <div class="sub-ck" onclick="toggleSub(${si})"></div>
      <span class="sub-text">${esc(s.text)}</span>
      <button class="sub-del" onclick="delSub(${si})">‚úï</button>
    </div>
  `).join('');
}
function toggleSub(si){if(openIdx===null)return;todos[openIdx].subs[si].done=!todos[openIdx].subs[si].done;save();render();renderSubs()}
function delSub(si){if(openIdx===null)return;todos[openIdx].subs.splice(si,1);save();render();renderSubs()}

$('#addSub').onclick=()=>{$('#subInput').classList.add('show');$('#subNi').focus()};
$('#subNi').onkeydown=e=>{
  if(e.key==='Enter'&&$('#subNi').value.trim()){
    todos[openIdx].subs.push({text:$('#subNi').value.trim(),done:false});
    $('#subNi').value='';save();render();renderSubs();
  }
  if(e.key==='Escape')$('#subInput').classList.remove('show');
};
$('#subNi').onblur=()=>setTimeout(()=>{
  if($('#subNi').value.trim()&&openIdx!==null){
    todos[openIdx].subs.push({text:$('#subNi').value.trim(),done:false});
    $('#subNi').value='';save();render();renderSubs();
  }
  $('#subInput').classList.remove('show');
},150);

// Comments
function renderComments(){
  if(openIdx===null)return;
  const t=ensureFields(todos[openIdx]);
  $('#commentList').innerHTML=t.comments.map(c=>{
    const d=new Date(c.ts);
    const time=d.toLocaleString('fr-FR',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'});
    return `<div class="comment-item"><div class="ci-text">${esc(c.text)}</div><div class="ci-time">${time}</div></div>`;
  }).join('');
}
$('#commentInput').oninput=()=>{$('#commentSend').disabled=!$('#commentInput').value.trim()};
$('#commentSend').onclick=addComment;
$('#commentInput').onkeydown=e=>{if(e.key==='Enter')addComment()};
function addComment(){
  const v=$('#commentInput').value.trim();
  if(!v||openIdx===null)return;
  todos[openIdx].comments.push({text:v,ts:Date.now()});
  $('#commentInput').value='';$('#commentSend').disabled=true;
  save();renderComments();
}

// Migrate
(function(){
  if(todos.length)return;
  for(const k of['bertoli-v5','bertoli-v4','bertoli-v3','bertoli-todos-v2']){
    const old=JSON.parse(localStorage.getItem(k)||'[]');
    if(old.length){todos=old.map(t=>ensureFields({text:t.text,done:t.done,priority:t.priority||4,subs:t.subs||[],time:t.time||'',date:t.date||'',label:t.label||t.cat||'',desc:'',comments:t.comments||[],ts:t.ts||Date.now()}));save();break}
  }
})();
todos.forEach(ensureFields);render();
</script>
</body>
</html>
